{% extends "base.html" %}

{% block title %}Run {{ job.display_name }} · Fine-Tuning{% endblock %}

{% block content %}
<section class="job-detail" data-job-id="{{ job.id }}">
  <div class="panel job-summary">
    <header>
      <h2>{{ job.display_name }}</h2>
      <span class="status status-{{ job.status.value }}">{{ job.status.value|capitalize }}</span>
    </header>
    {% set model_label = job.parameters.get('model_label') if job.parameters else None %}
    {% set dataset_mode = job.parameters.get('dataset_mode') if job.parameters else 'upload' %}
    {% set dataset_name = job.parameters.get('dataset_storage_name') if job.parameters else job.dataset_path %}
    {% set resolved_model = job.parameters.get('resolved_base_model') if job.parameters else job.base_model %}
    {% set reference_config = job.parameters.get('model_reference_config') if job.parameters else None %}
    {% set template_label = job.parameters.get('template_label') if job.parameters else None %}
    {% set template_source = job.parameters.get('template_source') if job.parameters else None %}
    {% set template_download = job.parameters.get('template_download_url') if job.parameters else None %}
    {% set template_path = job.parameters.get('template_path') if job.parameters else None %}
    <dl>
      <div><dt>Model</dt><dd>{{ model_label or resolved_model }}</dd></div>
      <div><dt>Base model ID</dt><dd><code>{{ resolved_model }}</code></dd></div>
      <div><dt>Training method</dt><dd>{{ job.training_method|upper }}</dd></div>
      <div><dt>Created</dt><dd>{{ job.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</dd></div>
      <div><dt>Started</dt><dd>{{ job.started_at.strftime('%Y-%m-%d %H:%M:%S') if job.started_at else '—' }}</dd></div>
      <div><dt>Completed</dt><dd>{{ job.completed_at.strftime('%Y-%m-%d %H:%M:%S') if job.completed_at else '—' }}</dd></div>
      <div><dt>Dataset file</dt><dd>{{ dataset_name }}{% if dataset_mode == 'existing' %}<span class="tag">Reused</span>{% endif %}</dd></div>
      <div><dt>Dataset path</dt><dd><code>{{ job.dataset_path }}</code></dd></div>
      <div><dt>Config</dt><dd><code>{{ job.config_path }}</code></dd></div>
      {% if template_label %}
        <div>
          <dt>Template</dt>
          <dd>
            {% if template_download %}
              <a href="{{ template_download }}" target="_blank" rel="noopener">{{ template_label }}</a>
            {% else %}
              {{ template_label }}
            {% endif %}
            {% if template_source %}<span class="tag">{{ template_source|capitalize }}</span>{% endif %}
          </dd>
        </div>
        {% if template_path %}
          <div><dt>Template reference</dt><dd><code>{{ template_path }}</code></dd></div>
        {% endif %}
      {% endif %}
      {% if reference_config %}
        <div><dt>Reference config</dt><dd><a href="{{ reference_config }}" target="_blank" rel="noopener">{{ reference_config }}</a></dd></div>
      {% endif %}
      <div><dt>Command</dt><dd><code>{{ job.docker_command }}</code></dd></div>
    </dl>
  </div>

  <div class="panel job-events">
    <h3>Events</h3>
    <ul id="event-list">
      {% for event in job.events %}
        <li><span class="timestamp">{{ event.created_at.strftime('%H:%M:%S') }}</span> {{ event.message }}</li>
      {% endfor %}
    </ul>
  </div>

  <div class="panel job-logs">
    <div class="logs-header">
      <h3>Logs</h3>
      <button type="button" class="secondary-btn" id="refresh-logs">Refresh</button>
    </div>
    <pre id="job-log">{{ initial_log | e }}</pre>
  </div>
</section>
{% endblock %}

{% block footer_scripts %}
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const container = document.querySelector('.job-detail');
    if (!container) return;
    const jobId = container.dataset.jobId;
    if (window.JobDetailController) {
      new window.JobDetailController(jobId);
    }
  });
</script>
{% endblock %}
